`/*
 * This file is part of Cockpit.
 *
 * Copyright (C) 2017 Red Hat, Inc.
 *
 * Cockpit is free software; you can redistribute it and/or modify it
 * under the terms of the GNU Lesser General Public License as published by
 * the Free Software Foundation; either version 2.1 of the License, or
 * (at your option) any later version.
 *
 * Cockpit is distributed in the hope that it will be useful, but
 * WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with Cockpit; If not, see <http://www.gnu.org/licenses/>.
 */

import React, { useState, useEffect, useRef, useMemo } from 'react';
// ä¿®æ­£ç·¨è­¯éŒ¯èª¤ï¼šä½¿ç”¨ window.cockpit ä½œç‚ºå…¨åŸŸè®Šæ•¸
const cockpit = (window as any).cockpit;

// åŒ¯å…¥æ‰€éœ€çš„ PatternFly çµ„ä»¶
import {
    Page, PageSection, Title, Button, TextInput,
    Toolbar, ToolbarContent, ToolbarItem,
    Card, CardBody, CardTitle,
    Dropdown, DropdownItem, 
    Divider,
} from '@patternfly/react-core'; 

// ç”±æ–¼ç·¨è­¯å™¨æ‰¾ä¸åˆ° DropdownToggleï¼Œæˆ‘å€‘ä½¿ç”¨ Dropdown.Toggle ä¾†ç¹éã€‚
// ç‚ºäº†ä¸è®“ç·¨è­¯å™¨å ±éŒ¯ï¼Œæˆ‘å€‘ä¹Ÿç§»é™¤ CommonJS åŒ¯å…¥
// @ts-ignore
// const { DropdownToggle } = require('@patternfly/react-core/deprecated'); 


// =========================================================================
// 1. Command Data and Styles
// =========================================================================

const commandInfo = {
    // Query/Browse Category
    ls: {
        template: "ls -l",
        text: "lsï¼šåˆ—å‡ºç›®éŒ„å…§å®¹ã€‚",
        detail: "`ls -l` æœƒä»¥ã€Œé•·æ ¼å¼ã€é¡¯ç¤ºæª”æ¡ˆæ¸…å–®ï¼ŒåŒ…å«æ¬Šé™ã€æ“æœ‰è€…ã€æª”æ¡ˆå¤§å°èˆ‡æœ€å¾Œä¿®æ”¹æ™‚é–“ï¼›åŠ ä¸Š `-a` å‰‡æœƒé€£åŒéš±è—æª”ä¸€èµ·é¡¯ç¤ºã€‚",
        danger: "low",
        category: "æŸ¥è©¢/ç€è¦½ (Query)"
    },
    pwd: {
        template: "pwd",
        text: "pwdï¼šé¡¯ç¤ºç›®å‰æ‰€åœ¨çš„å·¥ä½œç›®éŒ„ã€‚",
        detail: "`pwd` æœƒè¼¸å‡ºç›®å‰ shell æ‰€åœ¨çš„å®Œæ•´è·¯å¾‘ï¼ˆabsolute pathï¼‰ï¼Œæ–¹ä¾¿ç¢ºèªè‡ªå·±åœ¨æª”æ¡ˆç³»çµ±ä¸­çš„ä½ç½®ï¼Œä¾‹å¦‚ `/home/student`ã€‚",
        danger: "low",
        category: "æŸ¥è©¢/ç€è¦½ (Query)"
    },
    cat: {
        template: "cat /etc/os-release",
        text: "catï¼šå°‡æª”æ¡ˆå…§å®¹ç›´æ¥è¼¸å‡ºåˆ°çµ‚ç«¯æ©Ÿã€‚",
        detail: "`/etc` æ˜¯ç³»çµ±è¨­å®šæª”å¸¸ç”¨çš„ç›®éŒ„ï¼›`/etc/os-release` æ˜¯ç´”æ–‡å­—æª”ï¼Œè£¡é¢è¨˜éŒ„ä½œæ¥­ç³»çµ±åç¨±ã€ç‰ˆæœ¬è™Ÿã€ä»£è™Ÿç­‰è³‡è¨Šï¼Œæ‰€ä»¥ `cat /etc/os-release` å¸¸ç”¨ä¾†ç¢ºèªç›®å‰ä¸»æ©Ÿçš„ Linux ç™¼è¡Œç‰ˆèˆ‡ç‰ˆæœ¬ã€‚",
        danger: "low",
        category: "æŸ¥è©¢/ç€è¦½ (Query)"
    },
    // Permission Category
    chmod: {
        template: "chmod 755 script.sh",
        text: "chmodï¼šä¿®æ”¹æª”æ¡ˆæˆ–ç›®éŒ„çš„æ¬Šé™ã€‚",
        detail: "`755` ä»£è¡¨ï¼šæ“æœ‰è€…(user)=7(è®€å¯«åŸ·è¡Œ rwx)ï¼Œç¾¤çµ„(group)=5(è®€åŸ·è¡Œ r-x)ï¼Œå…¶ä»–äºº(others)=5(è®€åŸ·è¡Œ r-x)ã€‚é€™ç¨®è¨­å®šå¸¸ç”¨åœ¨å¯åŸ·è¡Œçš„ script æª”ä¸Šï¼Œè®“å…¶ä»–äººå¯ä»¥åŸ·è¡Œä½†ä¸èƒ½ä¿®æ”¹å…§å®¹ã€‚è«‹é¿å…å°ç³»çµ±é—œéµæª”æ¡ˆç”¨ 777ã€‚",
        danger: "medium",
        category: "æ¬Šé™è¨­å®š (Permission)"
    },
    chown: {
        template: "chown root:root /some/file",
        text: "chownï¼šè®Šæ›´æª”æ¡ˆçš„æ“æœ‰è€…èˆ‡ç¾¤çµ„ã€‚",
        detail: "`root:root` çš„æ ¼å¼æ˜¯ `ä½¿ç”¨è€…:ç¾¤çµ„`ã€‚é€™å€‹æŒ‡ä»¤æœƒæŠŠ `/some/file` çš„æ“æœ‰è€…å’Œç¾¤çµ„éƒ½æ”¹æˆ rootï¼Œä¸€èˆ¬ç”¨åœ¨ç³»çµ±æª”æ¡ˆæˆ–éœ€è¦ç‰¹å®šå¸³è™Ÿç®¡ç†çš„æª”æ¡ˆä¸Šï¼Œè‹¥è¨­å®šéŒ¯èª¤å¯èƒ½é€ æˆæ¬Šé™å•é¡Œã€‚",
        danger: "medium",
        category: "æ¬Šé™è¨­å®š (Permission)"
    },
    // System Control Category
    rm: {
        template: "rm test.txt",
        text: "rmï¼šåˆªé™¤æª”æ¡ˆã€‚",
        detail: "`rm` ä¸æœƒå°‡æª”æ¡ˆé€åˆ°è³‡æºå›æ”¶æ¡¶ï¼Œè€Œæ˜¯ç›´æ¥å¾æª”æ¡ˆç³»çµ±ç§»é™¤ï¼›`-r` æœƒéè¿´åˆªé™¤ç›®éŒ„ï¼Œ`-f` è¡¨ç¤ºä¸è©¢å•å¼·åˆ¶åˆªé™¤ã€‚å› æ­¤ `rm -rf` æ˜¯éå¸¸å±éšªçš„çµ„åˆï¼Œçµ•å°ä¸è¦å° `/` æˆ–é‡è¦ç³»çµ±ç›®éŒ„ä½¿ç”¨ã€‚",
        danger: "high",
        category: "ç³»çµ±æ“ä½œ (System Control)"
    },
    systemctl: {
        template: "systemctl restart nginx",
        text: "systemctlï¼šåœ¨ä½¿ç”¨ systemd çš„ç³»çµ±ä¸Šç®¡ç†æœå‹™ã€‚",
        detail: "`restart` æœƒå…ˆåœæ­¢å†é‡æ–°å•Ÿå‹•æŒ‡å®šæœå‹™ï¼Œé€™è£¡ä»¥ `nginx` ç‚ºä¾‹ã€‚é€™å€‹æŒ‡ä»¤å¸¸ç”¨æ–¼å¥—ç”¨æ–°çš„è¨­å®šæª”ï¼Œä½†è‹¥å° sshd ä¹‹é¡çš„é—œéµæœå‹™ä½¿ç”¨ï¼Œå¯èƒ½å°è‡´é ç«¯é€£ç·šä¸­æ–·ï¼Œè¦ç‰¹åˆ¥å°å¿ƒã€‚",
        danger: "high",
        category: "ç³»çµ±æ“ä½œ (System Control)"
    }
};

const dangerStyles = {
    low: { label: "ä½å±éšªåº¦", icon: "ğŸŸ¢", bg: "#d4edda", fg: "#155724", border: "#155724", desc: "æŸ¥è©¢ã€ç€è¦½é¡æŒ‡ä»¤ï¼Œé€šå¸¸ä¸æœƒæ”¹è®Šç³»çµ±ç‹€æ…‹ã€‚" },
    medium: { label: "ä¸­å±éšªåº¦", icon: "ğŸŸ¡", bg: "#fff3e0", fg: "#ef6c00", border: "#ef6c00", desc: "æœƒä¿®æ”¹æ¬Šé™æˆ–è¨­å®šï¼Œå¯èƒ½å½±éŸ¿å°‘æ•¸æª”æ¡ˆæˆ–æœå‹™ã€‚" },
    high: { label: "é«˜å±éšªåº¦", icon: "ğŸ”´", bg: "#ffebee", fg: "#c62828", border: "#c62828", desc: "å¯èƒ½åˆªé™¤è³‡æ–™æˆ–å½±éŸ¿ç³»çµ±æœå‹™ï¼Œä½¿ç”¨å‰éœ€ç‰¹åˆ¥å°å¿ƒã€‚" }
};

// All command categories for the dropdown
const allCategories = ["å…¨éƒ¨æŒ‡ä»¤ (All)", "æŸ¥è©¢/ç€è¦½ (Query)", "æ¬Šé™è¨­å®š (Permission)", "ç³»çµ±æ“ä½œ (System Control)"];


// =========================================================================
// 2. Main Teaching Terminal Component
// =========================================================================

const TeachingTerminal: React.FC = () => {
    const [output, setOutput] = useState("æ•™å­¸çµ‚ç«¯æ©Ÿå·²å°±ç·’ï¼Œè©¦è©¦çœ‹è¼¸å…¥æŒ‡ä»¤æˆ–é»ä¸‹é¢çš„æŒ‰éˆ•ï¼š\n");
    const [commandLine, setCommandLine] = useState("");
    const [currentInfo, setCurrentInfo] = useState<any>(null); 
    const outputBoxRef = useRef<HTMLPreElement>(null);
    const inputRef = useRef<HTMLInputElement>(null);
    
    // Dropdown state
    const [isDropdownOpen, setIsDropdownOpen] = useState(false);
    const [selectedCategory, setSelectedCategory] = useState("å…¨éƒ¨æŒ‡ä»¤ (All)");

    // Helper: Append output to terminal and autoscroll
    const appendOutput = (line: string) => {
        setOutput(prevOutput => prevOutput + line.replace(/\r/g, "") + "\n");
    };

    useEffect(() => {
        if (outputBoxRef.current) {
            outputBoxRef.current.scrollTop = outputBoxRef.current.scrollHeight;
        }
    }, [output]); 

    // Helper: Update info block based on command string
    const updateInfo = (cmd: string) => {
        const firstWord = cmd.split(/\s+/)[0];
        setCurrentInfo(commandInfo[firstWord] || null);
    };

    // Action: Select command from button (only populates input)
    const selectCommand = (template: string) => {
        setCommandLine(template);
        updateInfo(template);
        if (inputRef.current) {
            inputRef.current.focus(); 
        }
    };

    // Core Function: Execute command (true execution or demo)
    const runCommand = (cmd: string) => {
        const finalCmd = cmd.trim();
        if (!finalCmd) return;

        appendOutput("$ " + finalCmd);
        updateInfo(finalCmd); 
        setCommandLine(""); 

        if (cockpit && cockpit.spawn) {
            // True Execution
            cockpit.spawn(["bash", "-lc", finalCmd], { err: "out" })
                .stream((data: string) => {
                    appendOutput(data);
                })
                .done(() => {
                    appendOutput("");
                })
                .fail((err: any) => {
                    let msg = err.message || err;
                    if (typeof msg === 'object' && msg !== null) {
                        msg = JSON.stringify(msg);
                    }
                    appendOutput(`[éŒ¯èª¤] ${msg}`);
                });
        } else {
            // Fallback Demo Mode (Only runs if cockpit is unavailable)
            appendOutput(`(demo) ${finalCmd}`);
            appendOutput("[éŒ¯èª¤] é€™è£¡æœƒé¡¯ç¤ºæŒ‡ä»¤è¼¸å‡ºçš„çµæœã€‚è«‹åœ¨ Cockpit ç’°å¢ƒä¸­åŸ·è¡Œã€‚");
            appendOutput("");
        }
    };

    // Helper: Render danger label for inline display
    const renderDangerInline = (info: any) => {
        if (!info || !info.danger) {
            return null;
        }
        const style = dangerStyles[info.danger] || dangerStyles.low;
        return (
            <span style={{ 
                background: style.bg, 
                color: style.fg, 
                border: `1px solid ${style.border}`, 
                padding: '2px 10px', 
                borderRadius: '999px',
                fontWeight: 'bold',
                fontSize: '12px',
                marginRight: '10px'
            }}>
                {style.icon} {style.label}
            </span>
        );
    };

    // Helper: Render detailed explanation
    const renderExplanation = (info: any) => {
        if (!info) return (
            <div className="pf-u-mt-sm">
                <div>å°šæœªé¸æ“‡æŒ‡ä»¤ã€‚è«‹å…ˆé»é¸ä¸Šæ–¹å¸¸ç”¨æŒ‡ä»¤æŒ‰éˆ•æˆ–è¼¸å…¥æŒ‡ä»¤ã€‚</div>
                <div className="pf-u-mt-sm pf-u-font-size-sm pf-u-color-black-600">
                   å°æç¤ºï¼šä½ å¯ä»¥å…ˆçœ‹ä¸Šæ–¹çš„ã€Œå±éšªåº¦ã€å†æ±ºå®šè¦ä¸è¦åŸ·è¡Œé€™å€‹æŒ‡ä»¤ï¼Œ...
                </div>
            </div>
        );
        
        return (
            <div>
                <div className="pf-u-mb-xs">
                    <strong>æŒ‡ä»¤ç¯„ä¾‹ï¼š</strong> 
                    <code className="pf-u-background-color-black-100 pf-u-p-xs pf-u-border-radius">
                        {info.template}
                    </code>
                </div>
                {info.detail && <div className="pf-u-font-size-sm pf-u-color-black-700 pf-u-mt-xs">{info.detail}</div>}
                <div className="pf-u-mt-sm pf-u-font-size-sm pf-u-color-black-600">
                   å°æç¤ºï¼šä½ å¯ä»¥å…ˆçœ‹ä¸Šæ–¹çš„ã€Œå±éšªåº¦ã€å†æ±ºå®šè¦ä¸è¦åŸ·è¡Œé€™å€‹æŒ‡ä»¤ï¼Œ...
                </div>
            </div>
        );
    };

    // Filter commands based on selected category
    const filteredCommands = useMemo(() => {
        if (selectedCategory === "å…¨éƒ¨æŒ‡ä»¤ (All)") {
            return Object.keys(commandInfo);
        }
        return Object.keys(commandInfo).filter(cmd => 
            commandInfo[cmd].category === selectedCategory
        );
    }, [selectedCategory]);


    // =========================================================================
    // 3. Render JSX (Layout Fixes)
    // =========================================================================

    return (
        <Page>
            {/* Title and Introduction (Layout Fix: Use isWidthLimited={false} AND custom style to occupy full space) */}
            <PageSection 
                isWidthLimited={false} 
                className="pf-u-p-0 pf-u-pt-lg"
                style={{ maxWidth: 'unset', width: '100%' }} // CSS Priority Override
            >
                <Title headingLevel="h2" size="xl" className="pf-u-mb-md">æ•™å­¸çµ‚ç«¯æ©Ÿ</Title>
                <p>ä¸ŠåŠéƒ¨æ˜¯æ•™å­¸ç”¨çµ‚ç«¯æ©Ÿè¦–çª—ï¼Œä¸‹æ–¹å¯ä»¥é€éæŒ‰éˆ•é¸æ“‡æŒ‡ä»¤ï¼Œä¸¦æŸ¥çœ‹è©³ç´°èªªæ˜ã€‚</p>
            </PageSection>

            {/* Terminal Card */}
            <PageSection 
                isWidthLimited={false} 
                className="pf-u-p-0"
                style={{ maxWidth: 'unset', width: '100%' }} // CSS Priority Override
            >
                <Card className="pf-u-background-color-white">
                    <CardTitle className="pf-u-font-weight-bold">
                        [ æ•™å­¸çµ‚ç«¯æ©Ÿè¦–çª— ] classuser@vm01:~
                    </CardTitle>
                    <CardBody className="pf-u-p-md">
                        {/* Output Area */}
                        <pre 
                            ref={outputBoxRef}
                            style={{
                                background: '#000',
                                color: '#8ae234',
                                height: '260px',
                                overflowY: 'auto',
                                padding: '10px',
                                lineHeight: '1.4', 
                                borderRadius: '4px',
                                fontFamily: 'monospace'
                            }}
                        >
                            {output}
                        </pre>

                        {/* Input Area */}
                        <Toolbar className="pf-u-mt-md pf-u-p-0">
                            <ToolbarContent className="pf-u-p-0">
                                <ToolbarItem><span>$</span></ToolbarItem>
                                <ToolbarItem style={{ flexGrow: 1 }}>
                                    <TextInput
                                        ref={inputRef} 
                                        value={commandLine}
                                        onChange={(_event, value) => { setCommandLine(value); updateInfo(value); }} 
                                        onKeyDown={(e) => { if (e.key === 'Enter') runCommand(commandLine); }}
                                        placeholder="è¼¸å…¥æŒ‡ä»¤ï¼Œä¾‹å¦‚ï¼šls -R /etc"
                                        style={{ fontFamily: 'monospace' }}
                                        type="text"
                                    />
                                </ToolbarItem>
                                <ToolbarItem>
                                    <Button variant="primary" onClick={() => runCommand(commandLine)}>åŸ·è¡Œ</Button>
                                </ToolbarItem>
                            </ToolbarContent>
                        </Toolbar>
                    </CardBody>
                </Card>
            </PageSection>

            {/* Combined Info Card (Buttons + Explanation) */}
            <PageSection 
                isWidthLimited={false} 
                className="pf-u-mt-lg pf-u-p-0"
                style={{ maxWidth: 'unset', width: '100%' }} // CSS Priority Override
            >
                <Card>
                    <CardBody>
                        
                        {/* Command Buttons Toolbar (Left: Title, Right: Dropdown) */}
                        <Toolbar className="pf-u-p-0 pf-u-mb-md">
                            <ToolbarContent className="pf-u-p-0">
                                <ToolbarItem className="pf-u-mr-auto">
                                    <Title headingLevel="h3" size="md">å¸¸ç”¨æŒ‡ä»¤ï¼š</Title>
                                </ToolbarItem>
                                <ToolbarItem>
                                    {/* Dropdown for category selection */}
                                    <Dropdown
                                        toggle={
                                            // ä¿®æ­£ï¼šä½¿ç”¨ Dropdown.Toggle (PatternFly æ¨™æº–å¯«æ³•)
                                            <Dropdown.Toggle 
                                                onToggle={() => setIsDropdownOpen(!isDropdownOpen)}
                                                toggleVariant="primary"
                                            >
                                                {selectedCategory}
                                            </Dropdown.Toggle>
                                        }
                                        isOpen={isDropdownOpen}
                                        dropdownItems={allCategories.map((category) => (
                                            <DropdownItem 
                                                key={category} 
                                                onClick={() => {
                                                    setSelectedCategory(category);
                                                    setIsDropdownOpen(false);
                                                }}
                                            >
                                                {category}
                                            </DropdownItem>
                                        ))}
                                    />
                                </ToolbarItem>
                            </ToolbarContent>
                        </Toolbar>

                        {/* Button Display Area (Scrollable) */}
                        <div className="pf-u-mb-lg" style={{ maxHeight: '120px', overflowY: 'auto', padding: '5px' }}>
                            {filteredCommands.map(cmd => {
                                const info = commandInfo[cmd];
                                const style = dangerStyles[info.danger];
                                const tooltipTitle = `${style.icon} ${style.label} | ${info.text} | å±éšªåº¦æè¿°: ${style.desc}`;

                                return (
                                    <Button
                                        key={cmd}
                                        // Low-danger buttons are green using inline style override
                                        style={info.danger === 'low' ? {
                                            background: style.bg,
                                            color: style.fg,
                                            border: `1px solid ${style.border}`, 
                                            marginRight: '8px', 
                                            marginBottom: '8px'
                                        } : {marginRight: '8px', marginBottom: '8px'}}
                                        variant={info.danger === 'high' ? 'danger' : info.danger === 'medium' ? 'warning' : 'default'}
                                        onClick={() => selectCommand(info.template)}
                                        title={tooltipTitle} // Tooltip is here
                                    >
                                        {cmd}
                                    </Button>
                                );
                            })}
                        </div>
                        
                        <Divider className="pf-u-mb-md" />

                        {/* Detailed Explanation Block */}
                        <Title headingLevel="h3" size="md" className="pf-u-mb-md">æŒ‡ä»¤èªªæ˜ï¼š</Title>
                        
                        {/* Inline Danger Status */}
                        <div className="pf-u-mb-md">
                            <span className="pf-u-font-weight-bold pf-u-mr-md">å±éšªåº¦ï¼š</span>
                            {renderDangerInline(currentInfo)}
                            <span className="pf-u-font-size-sm pf-u-color-black-600">
                                {currentInfo ? dangerStyles[currentInfo.danger]?.desc : 'å°šæœªé¸æ“‡æŒ‡ä»¤ï¼Œè«‹å…ˆè¼¸å…¥æŒ‡ä»¤æˆ–é»é¸æŒ‰éˆ•ã€‚'}
                            </span>
                        </div>
                        
                        <Title headingLevel="h4" size="md" className="pf-u-mb-sm">è©³ç´°èªªæ˜ï¼š</Title>
                        {renderExplanation(currentInfo)}

                    </CardBody>
                </Card>
            </PageSection>
        </Page>
    );
};

export const Application = TeachingTerminal;
export default TeachingTerminal;
